-- FINAL GOLD STANDARD VERSION - REFACTORED AND CORRECTED
-- This version ranks the policies only ONCE for efficiency and guaranteed consistency,
-- and it filters out policies that have no product name (NULL wti_lob_txt).

WITH
-- Step 1: Create a clean, deduplicated list of policies with valid product names.
DistinctPolicies AS (
    SELECT DISTINCT
        axa_party_id,
        policy_no,
        wti_lob_txt,
        register_date,
        isrd_brth_date,
        acct_val_amt,
        face_amt,
        cash_val_amt
    FROM
        wealth_management_client_metrics
    WHERE
        axa_party_id IS NOT NULL
        AND policy_no IS NOT NULL
        AND register_date IS NOT NULL
        AND wti_lob_txt IS NOT NULL -- **FIX #2: Exclude policies with no name.**
),

-- **KEY REFACTOR: Rank all policies for each client just ONCE.**
RankedPolicies AS (
    SELECT *,
           ROW_NUMBER() OVER(PARTITION BY axa_party_id ORDER BY register_date ASC, policy_no ASC) as policy_rank
    FROM DistinctPolicies
),

-- Step 2: Create features and dates based ONLY on the first policy.
FirstPurchaseInfo AS (
    SELECT
        axa_party_id,
        wti_lob_txt AS initial_product_purchased,
        register_date AS first_purchase_date,
        isrd_brth_date AS client_birth_date,
        acct_val_amt AS first_policy_acct_val,
        face_amt AS first_policy_face_amt,
        cash_val_amt AS first_policy_cash_val
    FROM
        RankedPolicies -- Read from our single, consistent ranked list.
    WHERE
        policy_rank = 1
),

-- Step 3: Identify the target (second policy) and its purchase date.
NextProductTarget AS (
    SELECT
        axa_party_id,
        wti_lob_txt AS next_product_purchased,
        register_date AS second_purchase_date
    FROM
        RankedPolicies -- Read from our single, consistent ranked list.
    WHERE
        policy_rank = 2
),

-- (Other CTEs for static/summary info remain useful)
AgentLatestSnapshot AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY agent_code ORDER BY yearmo DESC) as rn
    FROM wealth_management_rpt_agents
),
ClientActivityMetrics AS (
    SELECT account_axa_party_id_c AS client_id, COUNT(task_id) AS total_activities_last_12m
    FROM wealth_management_activities
    WHERE activity_date >= ADD_MONTHS(CURRENT_DATE, -12)
    GROUP BY account_axa_party_id_c
),
LatestRetentionSnapshot AS (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY axa_party_id ORDER BY business_month DESC) as rn
    FROM wealth_management_pcpg_retention
)

-- Final SELECT: Assembling the complete, point-in-time feature set
SELECT
    -- ===== Primary Key =====
    ret.axa_party_id,

    -- ===== Static Client Features (Current state is acceptable) =====
    DATEDIFF(CURRENT_DATE, fpi.client_birth_date) / 365.25 AS current_client_age,
    ret.client_age_band,
    ret.city AS client_city,
    ret.state AS client_state,
    ret.client_segment,
    ret.client_tenure,
    ret.client_type,
    ret.aum_sum AS total_aum_with_us_today,
    ret.aum_band,

    -- ===== Point-in-Time Features =====
    fpi.initial_product_purchased,
    fpi.client_birth_date,
    fpi.first_purchase_date,
    tgt.second_purchase_date,
    MONTHS_BETWEEN(tgt.second_purchase_date, fpi.first_purchase_date) AS months_to_second_purchase,
    DATEDIFF(tgt.second_purchase_date, fpi.client_birth_date) / 365.25 AS age_at_second_purchase,
    fpi.first_policy_acct_val,
    fpi.first_policy_face_amt,
    fpi.first_policy_cash_val,
    
    -- ===== Engagement and Agent Features (Current state is acceptable) =====
    COALESCE(act.total_activities_last_12m, 0) AS total_activities_last_12m,
    ret.agent_code,
    agent.rpt_lgth_of_svc AS agent_length_of_service,
    agent.rank_desc AS agent_rank,
    agent.ppg_membership AS agent_is_ppg_member,

    -- ===== SINGLE TARGET VARIABLE =====
    tgt.next_product_purchased

FROM
    LatestRetentionSnapshot AS ret
LEFT JOIN AgentLatestSnapshot AS agent ON ret.agent_code = agent.agent_code AND agent.rn = 1
LEFT JOIN ClientActivityMetrics AS act ON ret.axa_party_id = act.client_id
-- **KEY CHANGE: Use INNER JOIN to ensure we only have clients with at least one valid policy.**
INNER JOIN FirstPurchaseInfo AS fpi ON ret.axa_party_id = fpi.axa_party_id
LEFT JOIN NextProductTarget AS tgt ON ret.axa_party_id = tgt.axa_party_id
WHERE
    ret.axa_party_id IS NOT NULL
    AND ret.rn = 1;
