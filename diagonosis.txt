WITH base AS (
    SELECT
        axa_party_id,
        policy_no,
        product_category,
        register_date,
        business_month
    FROM policy_table           -- <=== replace with your table name
    WHERE policy_status = 'ACTIVE'   -- optional: keep if inactive policies must be removed
),
ordered AS (
    SELECT
        axa_party_id,
        policy_no,
        product_category,
        register_date,
        ROW_NUMBER() OVER (PARTITION BY axa_party_id ORDER BY register_date ASC) AS rn
    FROM base
),
pairs AS (
    SELECT
        a.axa_party_id,
        a.product_category AS first_product,
        b.product_category AS next_product,
        a.register_date AS first_register_date,
        b.register_date AS second_register_date
    FROM ordered a
    JOIN ordered b
        ON a.axa_party_id = b.axa_party_id
       AND b.rn = a.rn + 1     -- strictly next policy in time
)
SELECT *
FROM pairs
WHERE next_product IS NOT NULL;


-------------------------------

WITH base AS (
    SELECT
        axa_party_id,
        product_category,
        register_date
    FROM policy_table            -- <=== replace with your table name
    WHERE policy_status = 'ACTIVE'
),
ordered AS (
    SELECT
        axa_party_id,
        product_category,
        register_date,
        ROW_NUMBER() OVER (PARTITION BY axa_party_id ORDER BY register_date ASC) AS rn,
        COUNT(*) OVER (PARTITION BY axa_party_id) AS total_active_policies
    FROM base
)
SELECT
    axa_party_id,
    product_category AS current_product,
    register_date AS register_date_of_current
FROM ordered
WHERE total_active_policies = 1   -- customers with exactly 1 active policy
  AND rn = 1;                     -- their only policy
----------------------------------------


%sql
with base as (
  select 
    r.axa_party_id,
    r.policy_no,
    r.register_date,
    r.trmn_eff_date,
    r.wti_lob_txt,
    r.prod_lob,
    r.agt_class,
    r.isrd_brth_date,
    r.psn_age,
    r.acct_val_amt,
    r.face_amt,
    r.cash_val_amt,
    r.wc_total_assets,
    r.wc_assetmix_stocks,
    r.wc_assetmix_bonds,
    r.wc_assetmix_mutual_funds,
    r.wc_assetmix_annuity,
    r.wc_assetmix_deposits,
    r.wc_assetmix_other_assets,
    r.division_name,
    r.mkt_prod_hier,
    r.policy_status,
    r.agent_segment,
    r.channel,
    r.client_seg,
    r.client_seg_1,
    r.aum_band,
    r.business_month,
    r.branchoffice_code,
    r.agt_no,
    h.sub_product_level_1,
    h.sub_product_level_2,
    h.Product,
    row_number() over (partition by r.axa_party_id order by r.register_date asc) as rn,
    row_number() over (partition by r.axa_party_id order by r.register_date asc) = 1 as is_first_policy
  from dl_tenants_daas.us_wealth_management.wealth_management_client_metrics r
  left join (
    select distinct source_sys_id, idb_plan_cd, idb_sub_plan_cd, 
      trim(stmt_plan_typ_txt) as Product, sub_product_level_1, sub_product_level_2
    from dl_tenants_daas.us_wealth_management.wealth_management_sub_product_group
  ) h 
    on upper(r.source_sys_id) = upper(h.source_sys_id)
    and trim(upper(REPLACE(LTRIM(REPLACE(r.plan_code,'0',' ')),' ','0'))) = trim(upper(h.idb_plan_cd))
    and trim(upper(REPLACE(LTRIM(REPLACE(r.plan_subcd_code,'0',' ')),' ','0'))) = trim(upper(h.idb_sub_plan_cd))
  where r.business_month = (select max(business_month) from dl_tenants_daas.us_wealth_management.wealth_management_client_metrics)
    and r.axa_party_id is not null
    and r.policy_no is not null
),
first_second as (
  select
    axa_party_id,
    -- First policy fields
    max(case when rn = 1 then policy_no end) as policy_no,
    max(case when rn = 1 then register_date end) as register_date,
    max(case when rn = 1 then trmn_eff_date end) as trmn_eff_date,
    max(case when rn = 1 then wti_lob_txt end) as wti_lob_txt,
    max(case when rn = 1 then prod_lob end) as prod_lob,
    max(case when rn = 1 then agt_class end) as agt_class,
    max(case when rn = 1 then isrd_brth_date end) as isrd_brth_date,
    max(case when rn = 1 then psn_age end) as psn_age,
    max(case when rn = 1 then acct_val_amt end) as acct_val_amt,
    max(case when rn = 1 then face_amt end) as face_amt,
    max(case when rn = 1 then cash_val_amt end) as cash_val_amt,
    max(case when rn = 1 then wc_total_assets end) as wc_total_assets,
    max(case when rn = 1 then wc_assetmix_stocks end) as wc_assetmix_stocks,
    max(case when rn = 1 then wc_assetmix_bonds end) as wc_assetmix_bonds,
    max(case when rn = 1 then wc_assetmix_mutual_funds end) as wc_assetmix_mutual_funds,
    max(case when rn = 1 then wc_assetmix_annuity end) as wc_assetmix_annuity,
    max(case when rn = 1 then wc_assetmix_deposits end) as wc_assetmix_deposits,
    max(case when rn = 1 then wc_assetmix_other_assets end) as wc_assetmix_other_assets,
    max(case when rn = 1 then client_seg end) as client_seg,
    max(case when rn = 1 then client_seg_1 end) as client_seg_1,
    max(case when rn = 1 then aum_band end) as aum_band,
    max(case when rn = 1 then sub_product_level_1 end) as sub_product_level_1,
    max(case when rn = 1 then sub_product_level_2 end) as sub_product_level_2,
    max(case when rn = 1 then Product end) as Product,
    max(case when rn = 1 then business_month end) as business_month,
    max(case when rn = 1 then branchoffice_code end) as branchoffice_code,
    max(case when rn = 1 then agt_no end) as agt_no,
    max(case when rn = 1 then division_name end) as division_name,
    max(case when rn = 1 then mkt_prod_hier end) as mkt_prod_hier,
    max(case when rn = 1 then policy_status end) as policy_status ,
    max(case when rn = 1 then channel end) as channel,
    max(case when rn = 1 then agent_segment end) as agent_segment,
    -- Second policy fields
    max(case when rn = 2 then policy_no end) as second_policy_no,
    max(case when rn = 2 then register_date end) as second_register_date,
    max(case when rn = 2 then trmn_eff_date end) as second_trmn_eff_date,
    max(case when rn = 2 then wti_lob_txt end) as second_wti_lob_txt,
    max(case when rn = 2 then prod_lob end) as second_prod_lob,
    max(case when rn = 2 then sub_product_level_1 end) as second_sub_product_level_1,
    max(case when rn = 2 then sub_product_level_2 end) as second_sub_product_level_2,
    max(case when rn = 2 then Product end) as second_Product
  from base
  where rn <= 2
  group by axa_party_id
)
select *,
  wc_assetmix_stocks / NULLIF(wc_total_assets, 0) AS stock_allocation_ratio,
  wc_assetmix_bonds / NULLIF(wc_total_assets, 0) AS bond_allocation_ratio,
  wc_assetmix_annuity / NULLIF(wc_total_assets, 0) AS annuity_allocation_ratio,
  wc_assetmix_mutual_funds / NULLIF(wc_total_assets, 0) AS mutual_fund_allocation_ratio,
  acct_val_amt / NULLIF(wc_total_assets, 0) AS aum_to_asset_ratio,
  face_amt / NULLIF(wc_total_assets, 0) AS policy_value_to_assets_ratio,
  
  CASE 
    WHEN prod_lob = 'LIFE' THEN 'LIFE_INSURANCE'
    WHEN sub_product_level_1 IN ('VLI', 'WL', 'UL/IUL', 'TERM', 'PROTECTIVE PRODUCT') THEN 'LIFE_INSURANCE'
    WHEN sub_product_level_2 LIKE '%LIFE%' THEN 'LIFE_INSURANCE'
    WHEN sub_product_level_2 IN ('VARIABLE UNIVERSAL LIFE', 'WHOLE LIFE', 'UNIVERSAL LIFE', 
                                'INDEX UNIVERSAL LIFE', 'TERM PRODUCT', 'VARIABLE LIFE', 
                                'SURVIVORSHIP WHOLE LIFE', 'MONY PROTECTIVE PRODUCT') THEN 'LIFE_INSURANCE'
    WHEN prod_lob IN ('GROUP RETIREMENT', 'INDIVIDUAL RETIREMENT') THEN 'RETIREMENT'
    WHEN sub_product_level_1 IN ('EQUIVEST', 'RETIREMENT 401K', 'ACCUMULATOR', 
                                'RETIREMENT CORNERSTONE', 'SCS', 'INVESTMENT EDGE') THEN 'RETIREMENT'
    WHEN sub_product_level_2 LIKE '%403B%' OR sub_product_level_2 LIKE '%401%' 
         OR sub_product_level_2 LIKE '%IRA%' OR sub_product_level_2 LIKE '%SEP%' THEN 'RETIREMENT'
    WHEN Product LIKE '%IRA%' OR Product LIKE '%401%' OR Product LIKE '%403%' 
         OR Product LIKE '%SEP%' OR Product LIKE '%Accumulator%' 
         OR Product LIKE '%Retirement%' THEN 'RETIREMENT'
    WHEN prod_lob = 'BROKER DEALER' THEN 'INVESTMENT'
    WHEN sub_product_level_1 IN ('INVESTMENT PRODUCT - DIRECT', 'INVESTMENT PRODUCT - BROKERAGE', 
                                'INVESTMENT PRODUCT - ADVISORY', 'DIRECT', 'BROKERAGE', 
                                'ADVISORY', 'CASH SOLICITOR') THEN 'INVESTMENT'
    WHEN sub_product_level_2 LIKE '%Investment%' OR sub_product_level_2 LIKE '%Brokerage%' 
         OR sub_product_level_2 LIKE '%Advisory%' THEN 'INVESTMENT'
    WHEN prod_lob = 'NETWORK' THEN 'NETWORK_PRODUCTS'
    WHEN sub_product_level_1 = 'NETWORK PRODUCTS' OR sub_product_level_2 = 'NETWORK PRODUCTS' THEN 'NETWORK_PRODUCTS'
    WHEN Product LIKE '%Network%' THEN 'NETWORK_PRODUCTS'
    WHEN prod_lob = 'OTHERS' AND sub_product_level_1 = 'HAS' THEN 'DISABILITY'
    WHEN sub_product_level_2 = 'HAS - DISABILITY' THEN 'DISABILITY'
    WHEN Product LIKE '%Disability%' OR Product LIKE '%DI -%' THEN 'DISABILITY'
    WHEN prod_lob = 'OTHERS' THEN 'HEALTH'
    WHEN sub_product_level_2 = 'GROUP HEALTH PRODUCTS' THEN 'HEALTH'
    WHEN Product LIKE '%Health%' OR Product LIKE '%Medical%' OR Product LIKE '%Hospital%' THEN 'HEALTH'
    ELSE 'OTHER'
  END AS product_category,
  CASE 
    WHEN second_prod_lob IS NULL THEN NULL
    WHEN second_prod_lob = 'LIFE' THEN 'LIFE_INSURANCE'
    WHEN second_sub_product_level_1 IN ('VLI', 'WL', 'UL/IUL', 'TERM', 'PROTECTIVE PRODUCT') THEN 'LIFE_INSURANCE'
    WHEN second_sub_product_level_2 LIKE '%LIFE%' THEN 'LIFE_INSURANCE'
    WHEN second_sub_product_level_2 IN ('VARIABLE UNIVERSAL LIFE', 'WHOLE LIFE', 'UNIVERSAL LIFE', 
                                'INDEX UNIVERSAL LIFE', 'TERM PRODUCT', 'VARIABLE LIFE', 
                                'SURVIVORSHIP WHOLE LIFE', 'MONY PROTECTIVE PRODUCT') THEN 'LIFE_INSURANCE'
    WHEN second_prod_lob IN ('GROUP RETIREMENT', 'INDIVIDUAL RETIREMENT') THEN 'RETIREMENT'
    WHEN second_sub_product_level_1 IN ('EQUIVEST', 'RETIREMENT 401K', 'ACCUMULATOR', 
                                'RETIREMENT CORNERSTONE', 'SCS', 'INVESTMENT EDGE') THEN 'RETIREMENT'
    WHEN second_sub_product_level_2 LIKE '%403B%' OR second_sub_product_level_2 LIKE '%401%' 
         OR second_sub_product_level_2 LIKE '%IRA%' OR second_sub_product_level_2 LIKE '%SEP%' THEN 'RETIREMENT'
    WHEN second_Product LIKE '%IRA%' OR second_Product LIKE '%401%' OR second_Product LIKE '%403%' 
         OR second_Product LIKE '%SEP%' OR second_Product LIKE '%Accumulator%' 
         OR second_Product LIKE '%Retirement%' THEN 'RETIREMENT'
    WHEN second_prod_lob = 'BROKER DEALER' THEN 'INVESTMENT'
    WHEN second_sub_product_level_1 IN ('INVESTMENT PRODUCT - DIRECT', 'INVESTMENT PRODUCT - BROKERAGE', 
                                'INVESTMENT PRODUCT - ADVISORY', 'DIRECT', 'BROKERAGE', 
                                'ADVISORY', 'CASH SOLICITOR') THEN 'INVESTMENT'
    WHEN second_sub_product_level_2 LIKE '%Investment%' OR second_sub_product_level_2 LIKE '%Brokerage%' 
         OR second_sub_product_level_2 LIKE '%Advisory%' THEN 'INVESTMENT'
    WHEN second_prod_lob = 'NETWORK' THEN 'NETWORK_PRODUCTS'
    WHEN second_sub_product_level_1 = 'NETWORK PRODUCTS' OR second_sub_product_level_2 = 'NETWORK PRODUCTS' THEN 'NETWORK_PRODUCTS'
    WHEN second_Product LIKE '%Network%' THEN 'NETWORK_PRODUCTS'
    WHEN second_prod_lob = 'OTHERS' AND second_sub_product_level_1 = 'HAS' THEN 'DISABILITY'
    WHEN second_sub_product_level_2 = 'HAS - DISABILITY' THEN 'DISABILITY'
    WHEN second_Product LIKE '%Disability%' OR second_Product LIKE '%DI -%' THEN 'DISABILITY'
    WHEN second_prod_lob = 'OTHERS' THEN 'HEALTH'
    WHEN second_sub_product_level_2 = 'GROUP HEALTH PRODUCTS' THEN 'HEALTH'
    WHEN second_Product LIKE '%Health%' OR second_Product LIKE '%Medical%' OR second_Product LIKE '%Hospital%' THEN 'HEALTH'
    ELSE 'OTHER'
  END AS second_product_category,
  CASE
    WHEN MONTH(register_date) BETWEEN 1 AND 3 THEN 'Q1'
    WHEN MONTH(register_date) BETWEEN 4 AND 6 THEN 'Q2'
    WHEN MONTH(register_date) BETWEEN 7 AND 9 THEN 'Q3'
    WHEN MONTH(register_date) BETWEEN 10 AND 12 THEN 'Q4'
    ELSE 'Unknown'
  END AS season_of_first_policy
  
from first_second

Loaded rows: 3856874

Inferred columns (change variables at top if incorrect):
 user id column: axa_party_id
 current product column: product_category
 next product (label) column: second_product_category
 timestamp column: register_date

Columns and dtypes:
axa_party_id                            object
policy_no                               object
register_date                   datetime64[ns]
trmn_eff_date                           object
wti_lob_txt                             object
prod_lob                                object
agt_class                               object
isrd_brth_date                  datetime64[ns]
psn_age                                float64
acct_val_amt                           float32
face_amt                               float32
cash_val_amt                           float32
wc_total_assets                        float64
wc_assetmix_stocks                     float64
wc_assetmix_bonds                      float64
wc_assetmix_mutual_funds               float64
wc_assetmix_annuity                    float64
wc_assetmix_deposits                   float64
wc_assetmix_other_assets               float64
client_seg                              object
client_seg_1                            object
aum_band                                object
sub_product_level_1                     object
sub_product_level_2                     object
Product                                 object
business_month                           int32
branchoffice_code                       object
agt_no                                  object
division_name                           object
mkt_prod_hier                           object
policy_status                           object
channel                                 object
agent_segment                           object
second_policy_no                        object
second_register_date            datetime64[ns]
second_trmn_eff_date                    object
second_wti_lob_txt                      object
second_prod_lob                         object
second_sub_product_level_1              object
second_sub_product_level_2              object
second_Product                          object
stock_allocation_ratio                 float64
bond_allocation_ratio                  float64
annuity_allocation_ratio               float64
mutual_fund_allocation_ratio           float64
aum_to_asset_ratio                     float64
policy_value_to_assets_ratio           float64
product_category                        object
second_product_category                 object
season_of_first_policy                  object
age_at_first_policy                    float64
age_at_second_policy                   float64
years_to_second                        float64
dtype: object


  
Saved sample rows to diagnostic_sample_rows.csv (first 10 + 10 random).

Sample rows (displaying key columns if available):
        axa_party_id register_date product_category second_product_category
00BK05RY27QPLN0IXXXX    1948-06-28   LIFE_INSURANCE              RETIREMENT
00BK05RY28AD2G2NXXXX    1952-07-01   LIFE_INSURANCE                    None
00BK05RY29C6MYNAXXXX    2024-06-28       RETIREMENT                    None
00BK05RY2BEZ09YCXXXX    1999-12-27 NETWORK_PRODUCTS                    None
00BK05RY2BNH4IVJXXXX    2004-04-07   LIFE_INSURANCE              RETIREMENT
00BK05RY2BYCTSHYXXXX    2005-07-11       RETIREMENT                    None
00BK05RY2CBQQUUQXXXX    2008-04-18 NETWORK_PRODUCTS                    None
00BK05RY2CGP257OXXXX    2013-11-22   LIFE_INSURANCE                    None
00BK05RY2CIBYQOTXXXX    1985-03-14   LIFE_INSURANCE                    None
00BK05RY2CSI4W4OXXXX    1985-10-01   LIFE_INSURANCE                    None
57BK05RY4MYSOFGCXXXX    2014-06-27       INVESTMENT                    None
03BK0ZLB8S9RM0L6XXXX    2013-01-25       RETIREMENT                    None
20248ac7230498707bc4    2025-05-08       INVESTMENT              INVESTMENT
20208ac723049459e30f    2020-02-05       INVESTMENT                    None
20238ac72304973ec1ff    2023-08-25       RETIREMENT                    None
14BK05RY4M574AVLXXXX    1988-10-10       RETIREMENT                    None
43BK08CFZXX05X2XXXXX    2003-05-09       RETIREMENT                    None
20178ac723049224e434    2017-02-01       RETIREMENT                    None
80BK0JG4ZB0DIWZEXXXX    2007-11-05       RETIREMENT                    None
20228ac7230496461a91    2022-09-14       RETIREMENT              RETIREMENT

Counts:
 total rows: 3856874
 unique users: 3856874
 unique target products (next): 6


Saved full label counts to diagnostic_label_counts.csv

Top 20 target products by count:
INVESTMENT          594509
RETIREMENT          243560
LIFE_INSURANCE      180005
NETWORK_PRODUCTS     73617
DISABILITY            2271
HEALTH                 124


User event counts summary:
count    3856874.0
mean           1.0
std            0.0
min            1.0
25%            1.0
50%            1.0
75%            1.0
max            1.0

      from_product       to_product   count     prob
      RETIREMENT             None 1503919 0.797116
      RETIREMENT       RETIREMENT  180125 0.095471
      RETIREMENT       INVESTMENT  130940 0.069402
      RETIREMENT   LIFE_INSURANCE   49191 0.026073
      RETIREMENT NETWORK_PRODUCTS   22408 0.011877
      RETIREMENT       DISABILITY      72 0.000038
      RETIREMENT           HEALTH      45 0.000024
  LIFE_INSURANCE             None  616608 0.720547
  LIFE_INSURANCE   LIFE_INSURANCE  116713 0.136387
  LIFE_INSURANCE       INVESTMENT   64360 0.075209
  LIFE_INSURANCE       RETIREMENT   40077 0.046833
  LIFE_INSURANCE NETWORK_PRODUCTS   17219 0.020122
  LIFE_INSURANCE       DISABILITY     733 0.000857
  LIFE_INSURANCE           HEALTH      40 0.000047
NETWORK_PRODUCTS             None  179883 0.687823
NETWORK_PRODUCTS       INVESTMENT   33961 0.129858
NETWORK_PRODUCTS NETWORK_PRODUCTS   29714 0.113618
NETWORK_PRODUCTS       RETIREMENT   10102 0.038627
NETWORK_PRODUCTS   LIFE_INSURANCE    7835 0.029959
NETWORK_PRODUCTS           HEALTH      17 0.000065
NETWORK_PRODUCTS       DISABILITY      13 0.000050
      INVESTMENT             None  396055 0.515193
      INVESTMENT       INVESTMENT  357669 0.465260
      INVESTMENT       RETIREMENT    8833 0.011490
      INVESTMENT   LIFE_INSURANCE    3386 0.004405
      INVESTMENT NETWORK_PRODUCTS    2796 0.003637
      INVESTMENT           HEALTH      11 0.000014
           OTHER             None   59555 0.811078
           OTHER       INVESTMENT    7261 0.098887
           OTHER       RETIREMENT    4076 0.055511
           OTHER   LIFE_INSURANCE    1529 0.020823
           OTHER NETWORK_PRODUCTS     994 0.013537
           OTHER       DISABILITY      11 0.000150
           OTHER           HEALTH       1 0.000014
      DISABILITY             None    6484 0.627079
      DISABILITY       DISABILITY    1442 0.139458
      DISABILITY   LIFE_INSURANCE    1317 0.127369
      DISABILITY NETWORK_PRODUCTS     471 0.045551
      DISABILITY       RETIREMENT     330 0.031915
      DISABILITY       INVESTMENT     296 0.028627
          HEALTH             None     284 0.743455
          HEALTH   LIFE_INSURANCE      34 0.089005
          HEALTH       INVESTMENT      22 0.057592
          HEALTH       RETIREMENT      17 0.044503
          HEALTH NETWORK_PRODUCTS      15 0.039267
          HEALTH           HEALTH      10 0.026178


  report.json:
{'n_labels': 6,
 'label_counts_top10': {'INVESTMENT': 594509,
  'RETIREMENT': 243560,
  'LIFE_INSURANCE': 180005,
  'NETWORK_PRODUCTS': 73617,
  'DISABILITY': 2271,
  'HEALTH': 124},
 'label_count_median': 126811.0,
 'label_count_mean': 182347.66666666666,
 'labels_less_than_1': 0,
 'labels_less_than_1_fraction': 0.0,
 'labels_less_than_5': 0,
 'labels_less_than_5_fraction': 0.0,
 'labels_less_than_10': 0,
 'labels_less_than_10_fraction': 0.0,
 'labels_less_than_20': 0,
 'labels_less_than_20_fraction': 0.0,
 'labels_less_than_50': 0,
 'labels_less_than_50_fraction': 0.0,
 'label_count_p50': 126811,
 'label_count_p75': 227671,
 'label_count_p90': 419034,
 'label_count_p95': 506771,
 'label_count_p99': 576961}


{'n_total_rows': 3856874,
 'n_rows_with_target': 1094096,
 'train_rows': 875276,
 'test_rows': 218820,
 'baseline_mf_recall@1_3_5': [0.8045334064527923,
  0.8045334064527923,
  0.8045334064527923],
 'baseline_markov_recall@1_3_5': [0.8221232062882735,
  0.9840828077872223,
  0.999963440270542],
 'lgb_recall@1_3_5': [0.8808472717301892,
  0.9885750845443744,
  0.9999360204734485],
 'labels': ['DISABILITY',
  'HEALTH',
  'INVESTMENT',
  'LIFE_INSURANCE',
  'NETWORK_PRODUCTS',
  'RETIREMENT']}


LightGBM eval recall@1/3/5: 0.8808472717301892 0.9885750845443744 0.9999360204734485
Saved feature importance to feature_importance.csv
                     feature         gain
       bond_allocation_ratio 3.365695e+08
         age_at_first_policy 2.632489e+08
    annuity_allocation_ratio 2.342210e+08
      stock_allocation_ratio 1.383051e+08
                    face_amt 1.066928e+08
mutual_fund_allocation_ratio 7.744850e+07
                cash_val_amt 7.290774e+07
                acct_val_amt 7.033437e+07
          aum_to_asset_ratio 6.324651e+07
policy_value_to_assets_ratio 5.809265e+07
               policy_status 2.058069e+07
               agent_segment 6.581382e+06
            product_category 3.025361e+06
                      agt_no 1.742217e+06
                    prod_lob 1.092982e+06
         sub_product_level_2 7.534656e+05
           branchoffice_code 7.192593e+05
         sub_product_level_1 5.244361e+05
                client_seg_1 1.947956e+05
                     psn_age 1.466313e+05
                  client_seg 6.067504e+04
               mkt_prod_hier 2.855813e+04
                    aum_band 3.645347e+03
               division_name 1.638106e+03
                     channel 5.253222e+02
      season_of_first_policy 2.337055e+01
              business_month 0.000000e+00
Saved model predictions to lgb_test_predictions.csv
Saved modeling_report.json
DONE.
 2) diagnostic_report.json contents (or paste key fields below).
 3) First 20 rows of diagnostic_sample_rows.csv (or attach the file).
 4) diagnostic_label_counts.csv top 50 rows (if available).

Once you paste those, I'll run the targeted diagnosis and give a prioritized experiment plan.


Index(['axa_party_id', 'policy_no', 'register_date', 'trmn_eff_date',
       'wti_lob_txt', 'prod_lob', 'agt_class', 'isrd_brth_date', 'psn_age',
       'acct_val_amt', 'face_amt', 'cash_val_amt', 'wc_total_assets',
       'wc_assetmix_stocks', 'wc_assetmix_bonds', 'wc_assetmix_mutual_funds',
       'wc_assetmix_annuity', 'wc_assetmix_deposits',
       'wc_assetmix_other_assets', 'client_seg', 'client_seg_1', 'aum_band',
       'sub_product_level_1', 'sub_product_level_2', 'Product',
       'business_month', 'branchoffice_code', 'agt_no', 'division_name',
       'mkt_prod_hier', 'policy_status', 'channel', 'agent_segment',
       'second_policy_no', 'second_register_date', 'second_trmn_eff_date',
       'second_wti_lob_txt', 'second_prod_lob', 'second_sub_product_level_1',
       'second_sub_product_level_2', 'second_Product',
       'stock_allocation_ratio', 'bond_allocation_ratio',
       'annuity_allocation_ratio', 'mutual_fund_allocation_ratio',
       'aum_to_asset_ratio', 'policy_value_to_assets_ratio',
       'product_category', 'second_product_category', 'season_of_first_policy',
       'age_at_first_policy', 'age_at_second_policy', 'years_to_second'],
      dtype='object')



Fold 5 macro F1 (ensemble on val): 0.6966

OOF Macro F1: 0.6959700190546122

Per-class report:
                  precision    recall  f1-score   support

      DISABILITY       0.90      0.77      0.83      2271
          HEALTH       0.00      0.02      0.01       125
      INVESTMENT       0.92      0.98      0.95    594508
  LIFE_INSURANCE       0.89      0.87      0.88    180002
NETWORK_PRODUCTS       0.84      0.46      0.59     73618
      RETIREMENT       0.91      0.92      0.92    243562

        accuracy                           0.91   1094086
       macro avg       0.75      0.67      0.70   1094086
    weighted avg       0.91      0.91      0.91   1094086

Confusion matrix (rows=true, cols=pred):
 [[  1749     20      6     85     47    364]
 [     7      3     71      4     20     20]
 [    13    263 583964   6711    807   2750]
 [    22    184  15423 156139   2326   5908]
 [    12     80  18983   8987  33658  11898]
 [   143    187  13848   3105   3125 223154]]
Saved feature importance.




Evaluating ranking performance (top-1)...
Ranking model macro F1 (top-1): 0.5468981480468839

Classification report (ranking top-1):
                  precision    recall  f1-score   support

      DISABILITY       0.40      0.30      0.34      2271
          HEALTH       1.00      0.62      0.77       125
      INVESTMENT       0.77      0.77      0.77    594508
  LIFE_INSURANCE       0.53      0.55      0.54    180002
NETWORK_PRODUCTS       0.57      0.19      0.29     73618
      RETIREMENT       0.53      0.62      0.57    243562

        accuracy                           0.66   1094086
       macro avg       0.63      0.51      0.55   1094086
    weighted avg       0.66      0.66      0.65   1094086

Confusion matrix (rows=true, cols=pred):
                  DISABILITY  HEALTH  ...  NETWORK_PRODUCTS  RETIREMENT
DISABILITY               684       0  ...                21         354
HEALTH                     0      78  ...                 9           4
INVESTMENT               118       0  ...             10280       84520
LIFE_INSURANCE           558       0  ...               295       34098
NETWORK_PRODUCTS         201       0  ...             14302       15640
RETIREMENT               134       0  ...               238      151928

[6 rows x 6 columns]

Done. Output saved to model_output
