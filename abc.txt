# ============================================
# ENHANCED TALKING POINTS GENERATION
# ============================================

import pandas as pd
import numpy as np

print("ðŸ’¬ Generating Enhanced Talking Points...")
print("=" * 80)

# First, create df_explanations DataFrame from SHAP analysis results
# This will contain top features, their values, and SHAP contributions for each client

df_explanations_list = []

for idx in range(len(shap_pred_data)):
    actual_idx = shap_pred_indices[idx]
    client_id = pred_pd.iloc[actual_idx]['cont_id']
    pred_class = pred_pd.iloc[actual_idx]['pred_class_id']
    pred_product = pred_pd.iloc[actual_idx]['pred_product']
    pred_prob = pred_pd.iloc[actual_idx]['pred_prob']
    
    # Get demographic data if available
    client_demo = None
    if idx < len(shap_final_preds):
        client_demo = shap_final_preds.iloc[idx]
    
    # Get SHAP values for the predicted class
    if pred_class >= len(shap_values_pred):
        pred_class = len(shap_values_pred) - 1
    shap_vals = shap_values_pred[pred_class][idx]
    
    # Get feature contributions
    feature_contributions = []
    for i, feat in enumerate(feature_cols_final):
        contrib = shap_vals[i]
        feat_val = shap_pred_data.iloc[idx][feat]
        
        # Get actual feature value (try to get from client_demo if available for better context)
        actual_value = feat_val
        if client_demo is not None:
            # Map feature names to actual column names
            feat_mapping = {
                'acct_val_amt': 'acct_val_amt',
                'wc_total_assets': 'wc_total_assets',
                'psn_age': 'psn_age',
                'channel_idx': 'channel',
                'client_seg': 'client_seg',
                'aum_band': 'aum_band',
                'wc_assetmix_stocks': 'wc_assetmix_stocks',
                'wc_assetmix_annuity': 'wc_assetmix_annuity',
            }
            
            # Check if we can get a better value from client_demo
            for key, col_name in feat_mapping.items():
                if key in feat and col_name in client_demo:
                    try:
                        actual_value = client_demo[col_name]
                        break
                    except:
                        pass
        
        feature_contributions.append({
            'feature': feat,
            'shap_value': contrib,
            'feature_value': actual_value
        })
    
    # Sort by absolute SHAP value
    feature_contributions.sort(key=lambda x: abs(x['shap_value']), reverse=True)
    
    # Get top 5 features
    top_features = feature_contributions[:5]
    
    # Create row for df_explanations
    row = {
        'cont_id': client_id,
        'axa_party_id': client_demo.get('axa_party_id', 'N/A') if client_demo is not None else 'N/A',
        'product': pred_product,
        'score': pred_prob,
        'pred_class_id': pred_class
    }
    
    # Add top 5 features
    for rank in range(1, 6):
        if rank <= len(top_features):
            feat_info = top_features[rank - 1]
            row[f'top_feature_{rank}'] = feat_info['feature']
            row[f'top_feature_{rank}_value'] = feat_info['feature_value']
            row[f'top_feature_{rank}_shap'] = feat_info['shap_value']
        else:
            row[f'top_feature_{rank}'] = None
            row[f'top_feature_{rank}_value'] = None
            row[f'top_feature_{rank}_shap'] = None
    
    # Add additional context fields from client_demo if available
    if client_demo is not None:
        for field in ['psn_age', 'wc_total_assets', 'acct_val_amt', 'wc_assetmix_stocks', 
                      'channel', 'aum_band', 'client_tenure', 'client_seg', 'client_seg_1']:
            if field in client_demo:
                row[field] = client_demo[field]
    
    df_explanations_list.append(row)

df_explanations = pd.DataFrame(df_explanations_list)

# Enhanced talking point templates with context and actions
ENHANCED_TEMPLATES = {
    'acct_val_amt': {
        'base': 'Account value of ${value:,.0f}',
        'context': lambda v: 'strong capacity' if v > 50000 else 'good capacity' if v > 25000 else 'moderate capacity',
        'action': 'Discuss portfolio diversification'
    },
    'wc_total_assets': {
        'base': 'Total assets of ${value:,.0f}',
        'context': lambda v: 'high net worth client' if v > 100000 else 'substantial assets',
        'action': 'Explore comprehensive wealth planning'
    },
    'aum_segment': {
        'base': 'AUM tier: {value}',
        'context': lambda v: 'premium client segment' if v == 'HIGH' else 'core client segment',
        'action': lambda v: 'White-glove service approach' if v == 'HIGH' else 'Standard advisory approach'
    },
    'wc_assetmix_stocks': {
        'base': 'Stock allocation: ${value:,.0f}',
        'context': 'equity-focused portfolio',
        'action': 'Position growth products'
    },
    'aggressive_investor': {
        'base': 'Aggressive risk profile',
        'context': 'high-growth orientation',
        'action': 'Emphasize equity and growth opportunities'
    },
    'conservative_investor': {
        'base': 'Conservative risk profile',
        'context': 'capital preservation focus',
        'action': 'Highlight stability and guaranteed products'
    },
    'client_age': {
        'base': 'Age {value:.0f}',
        'context': lambda v: 'retirement planning window' if v > 55 else 'wealth accumulation phase' if v > 40 else 'early career',
        'action': lambda v: 'Focus on retirement readiness' if v > 55 else 'Emphasize long-term growth'
    },
    'psn_age': {
        'base': 'Age {value:.0f}',
        'context': lambda v: 'retirement planning window' if v > 55 else 'wealth accumulation phase' if v > 40 else 'early career',
        'action': lambda v: 'Focus on retirement readiness' if v > 55 else 'Emphasize long-term growth'
    },
    'retirement_planning_trigger': {
        'base': 'Retirement planning phase',
        'context': 'active retirement preparation',
        'action': 'Lead with retirement income solutions'
    },
    'snp_close_lead_6': {
        'base': 'S&P 6-month trend: {value:+.1f}%',
        'context': lambda v: 'positive market momentum' if v > 0 else 'market correction opportunity',
        'action': lambda v: 'Act on current strength' if v > 0 else 'Position for recovery'
    },
    'channel': {
        'base': 'Channel: {value}',
        'context': lambda v: 'advisor relationship' if 'Advisor' in str(v) else 'direct channel',
        'action': lambda v: 'Leverage advisor trust' if 'Advisor' in str(v) else 'Personal outreach approach'
    },
    'channel_idx': {
        'base': 'Channel: {value}',
        'context': lambda v: 'advisor relationship' if 'Advisor' in str(v) else 'direct channel',
        'action': lambda v: 'Leverage advisor trust' if 'Advisor' in str(v) else 'Personal outreach approach'
    },
    'client_tenure_years': {
        'base': '{value:.0f} years with us',
        'context': lambda v: 'long-standing relationship' if v > 10 else 'established client' if v > 5 else 'newer client',
        'action': lambda v: 'Deepen existing relationship' if v > 5 else 'Build trust and engagement'
    },
    'client_tenure': {
        'base': '{value:.1f} years with us',
        'context': lambda v: 'long-standing relationship' if v > 10 else 'established client' if v > 5 else 'newer client',
        'action': lambda v: 'Deepen existing relationship' if v > 5 else 'Build trust and engagement'
    },
    'hist_': {
        'base': 'Recent purchase history: {value}',
        'context': 'strong engagement pattern',
        'action': 'Build on existing relationship'
    },
    'last_1': {
        'base': 'Most recent product: {value}',
        'context': 'active client engagement',
        'action': 'Natural product progression'
    },
    'last_2': {
        'base': 'Previous product: {value}',
        'context': 'diverse product portfolio',
        'action': 'Complement existing holdings'
    },
    'freq_': {
        'base': 'Purchase frequency: {value}',
        'context': 'consistent engagement',
        'action': 'Leverage loyalty'
    },
    'wc_assetmix_annuity': {
        'base': 'Annuity allocation: ${value:,.0f}',
        'context': 'income-focused strategy',
        'action': 'Expand retirement income solutions'
    },
    'face_amt': {
        'base': 'Face amount: ${value:,.0f}',
        'context': 'significant coverage',
        'action': 'Review coverage adequacy'
    },
    'cash_val_amt': {
        'base': 'Cash value: ${value:,.0f}',
        'context': 'accumulated value',
        'action': 'Optimize cash value growth'
    }
}

def generate_enhanced_talking_point(feature_name, feature_value, shap_value, id2prod=None):
    """Generate enhanced talking point with context and action"""
    # Impact indicator
    impact = "ðŸ”¥" if abs(shap_value) > 0.1 else "â­" if abs(shap_value) > 0.05 else ""
    
    # Handle special cases for history features
    if feature_name.startswith('hist_'):
        # Try to map to product name
        if id2prod is not None:
            try:
                prod_id = int(feature_value)
                if prod_id > 0 and prod_id in id2prod:
                    feature_value = id2prod[prod_id]
            except:
                pass
        template_dict = ENHANCED_TEMPLATES.get('hist_', None)
    elif feature_name.startswith('freq_'):
        template_dict = ENHANCED_TEMPLATES.get('freq_', None)
    else:
        # Find matching template
        template_dict = None
        for template_key in ENHANCED_TEMPLATES:
            if template_key in feature_name or feature_name.startswith(template_key):
                template_dict = ENHANCED_TEMPLATES[template_key]
                break
    
    if not template_dict:
        # Fallback to simple format
        return f"{impact} {feature_name}: {feature_value} (impact: {shap_value:+.3f})"
    
    # Format base message
    try:
        template = template_dict['base']
        if '{value' in template:
            # Convert to numeric if needed
            if isinstance(feature_value, str) and feature_value not in ['N/A', 'UNKNOWN', None]:
                try:
                    feature_value = float(feature_value)
                except:
                    pass
            elif feature_value is None or (isinstance(feature_value, float) and np.isnan(feature_value)):
                return f"{impact} {feature_name}: N/A"
            
            message = template.format(value=feature_value)
        else:
            message = template
    except Exception as e:
        message = f"{feature_name}: {feature_value}"
    
    # Add context
    context = template_dict.get('context')
    if context:
        if callable(context):
            try:
                context_str = context(feature_value)
            except:
                context_str = None
        else:
            context_str = context
        
        if context_str:
            message += f" ({context_str})"
    
    # Add action
    action = template_dict.get('action')
    if action:
        if callable(action):
            try:
                action_str = action(feature_value)
            except:
                action_str = None
        else:
            action_str = action
        
        if action_str:
            message += f" â†’ {action_str}"
    
    return f"{impact} {message}"

# Generate enhanced talking points and add as new columns
if len(df_explanations) > 0:
    for i in range(len(df_explanations)):
        for rank in range(1, 6):
            feature = df_explanations.iloc[i][f'top_feature_{rank}']
            value = df_explanations.iloc[i][f'top_feature_{rank}_value']
            shap_val = df_explanations.iloc[i][f'top_feature_{rank}_shap']
            
            if pd.notna(feature) and pd.notna(shap_val):
                enhanced_tp = generate_enhanced_talking_point(feature, value, shap_val, id2prod)
                df_explanations.loc[i, f'enhanced_talking_point_{rank}'] = enhanced_tp
            else:
                df_explanations.loc[i, f'enhanced_talking_point_{rank}'] = None
    
    print(f"Generated enhanced talking points for {len(df_explanations):,} records")
    
    # Show sample
    print("\nðŸ“‹ Sample Enhanced Explanation:")
    print("=" * 80)
    if len(df_explanations) > 0:
        sample = df_explanations.iloc[0]
        print(f"Client: {sample.get('axa_party_id', sample.get('cont_id', 'N/A'))}")
        print(f"Product: {sample['product'].title()}")
        print(f"Score: {sample['score']:.3f}")
        print(f"\nTop Reasons (Enhanced):")
        for i in range(1, 6):
            tp = sample.get(f'enhanced_talking_point_{i}')
            if pd.notna(tp):
                print(f"{i}. {tp}")
    else:
        print("No samples available")
else:
    print("\nWARNING: No explanations to enhance")

print("\nEnhanced talking points complete")
print("=" * 80)

# Display sample of df_explanations
print("\nðŸ“Š Sample df_explanations DataFrame:")
display(df_explanations.head(5))
