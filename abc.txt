# Generate talking points for the sample
    print("Generating talking points...")
    id2prod = python_model.id2prod
    
    # Create a lookup dictionary for faster access to predictions
    predictions_dict = predictions.set_index('cont_id')[['pred_product', 'pred_prob']].to_dict('index')
    
    # Get top features for each sample
    talking_points_list = []
    print(f"  Processing {len(pred_pd_sample):,} samples...")
    
    for idx in range(len(pred_pd_sample)):
        if (idx + 1) % 10000 == 0:
            print(f"    Processed {idx + 1:,} / {len(pred_pd_sample):,} samples...")
        
        cont_id = pred_pd_sample.iloc[idx]['cont_id']
        
        # Get prediction info from dictionary (faster than repeated filtering)
        pred_info = predictions_dict.get(cont_id, {'pred_product': 'UNKNOWN', 'pred_prob': 0.0})
        pred_product = pred_info['pred_product']
        pred_prob = pred_info['pred_prob']
        
        # Get feature contributions (SHAP values)
        shap_contributions = shap_array[idx]
        
        # Ensure shap_contributions is 1D array
        if isinstance(shap_contributions, np.ndarray) and shap_contributions.ndim > 1:
            shap_contributions = shap_contributions.flatten()
        
        # Get top 5 features
        feature_contributions = list(zip(feature_cols, shap_contributions))
        # Sort by absolute SHAP value
        feature_contributions.sort(key=lambda x: abs(float(x[1])), reverse=True)
        top_features = feature_contributions[:5]
        
        # Generate talking points
        valid_talking_points = []
        for rank, (feat_name, shap_val) in enumerate(top_features, 1):
            try:
                feat_value = pred_pd_sample.iloc[idx][feat_name]
                tp = generate_enhanced_talking_point(feat_name, feat_value, shap_val, id2prod)
                if tp is not None:
                    valid_talking_points.append(tp)
            except Exception as e:
                # Skip this feature if there's an error
                continue
        
        talking_points_list.append({
            'cont_id': cont_id,
            'pred_product': pred_product,
            'pred_prob': pred_prob,
            'talking_point_1': valid_talking_points[0] if len(valid_talking_points) > 0 else None,
            'talking_point_2': valid_talking_points[1] if len(valid_talking_points) > 1 else None,
            'talking_point_3': valid_talking_points[2] if len(valid_talking_points) > 2 else None,
            'talking_point_4': valid_talking_points[3] if len(valid_talking_points) > 3 else None,
            'talking_point_5': valid_talking_points[4] if len(valid_talking_points) > 4 else None,
        })
    
    # Create DataFrame with talking points
    talking_points_df = pd.DataFrame(talking_points_list)
    
    # Merge talking points back to predictions
    # For the sample that has talking points
    predictions_with_tp = predictions.merge(talking_points_df[['cont_id', 'talking_point_1', 'talking_point_2', 
                                                               'talking_point_3', 'talking_point_4', 'talking_point_5']], 
                                           on='cont_id', how='left')
    
    # For records without talking points (not in sample), ensure columns exist and are properly typed
    for col in ['talking_point_1', 'talking_point_2', 'talking_point_3', 'talking_point_4', 'talking_point_5']:
        if col not in predictions_with_tp.columns:
            predictions_with_tp[col] = None
        # Convert to object dtype to handle None values properly
        predictions_with_tp[col] = predictions_with_tp[col].astype('object')
        # Replace NaN with None (using fillna with value parameter)
        predictions_with_tp.loc[predictions_with_tp[col].isna(), col] = None
    
    print(f"✓ Generated talking points for {len(talking_points_df):,} records")
    print(f"\n  Sample talking points:")
    sample_tp = talking_points_df.head(3)
    for _, row in sample_tp.iterrows():
        print(f"\n  Client: {row['cont_id']}")
        print(f"    Product: {row['pred_product']}")
        print(f"    Probability: {row['pred_prob']:.3f}")
        for i in range(1, 6):
            tp = row.get(f'talking_point_{i}')
            if pd.notna(tp) and tp is not None:
                print(f"    {i}. {tp}")
    
    # Update predictions with talking points
    predictions = predictions_with_tp
    
except Exception as e:
    print(f"⚠ Could not generate talking points: {e}")
    import traceback
    traceback.print_exc()
    print("Continuing without talking points...")
